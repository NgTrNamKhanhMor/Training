<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/6.4.1/mdb.min.css" rel="stylesheet">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/6.4.1/mdb.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <style>
    .calculator-container {
      max-width: 500px;
      margin: 0 auto;
    }

    .display {
      font-size: 1.5em;
    }

    .button {
      height: 60px;
      font-size: 1.2em;
      /* border: 1px grey solid; */
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    #display {
      width: 100%;
      height: 50px;
    }
  </style>
</head>

<body>
  <div class="container px-4 px-lg-5 bg-light border border-2 rounded-2 h-100 my-4 p-5 calculator-container">
    <div class="row mb-5">
      <div class="col-12 text-bg-secondary text-center p-0">
        <div class="w-100 display text-center p-2 -0 w-auto" id="display"></div>
      </div>
    </div>
    <div class="row g-3">
      <div class="col-3 button p-0 c">
        <button type="button" class="btn btn-outline-danger w-100 h-100 ripple-surface">C</button>
      </div>
      <div class="col-3 button p-0 sqrt">
        <button type="button" class="btn btn-outline-primary w-100 h-100 ripple-surface">&radic;</button>
      </div>
      <div class="col-3 button p-0 square">
        <button type="button" class="btn btn-outline-primary w-100 h-100 ripple-surface">x<sup>2</sup></button>
      </div>
      <div class="col-3 button op p-0" data-value="+">
        <button type="button" class="btn btn-outline-primary w-100 h-100 ripple-surface">+</button>
      </div>
    </div>
    <div class="row g-3">
      <div class="col-3 button num p-0" data-value="7">
        <button type="button" class="btn btn-outline-dark w-100 h-100 ripple-surface">7</button>
      </div>
      <div class="col-3 button num p-0" data-value="8">
        <button type="button" class="btn btn-outline-dark w-100 h-100 ripple-surface">8</button>
      </div>
      <div class="col-3 button num p-0" data-value="9">
        <button type="button" class="btn btn-outline-dark w-100 h-100 ripple-surface">9</button>
      </div>
      <div class="col-3 button op p-0" data-value="-">
        <button type="button" class="btn btn-outline-primary w-100 h-100 ripple-surface">-</button>
      </div>
    </div>
    <div class="row g-3">
      <div class="col-3 button num p-0" data-value="4">
        <button type="button" class="btn btn-outline-dark w-100 h-100 ripple-surface">4</button>
      </div>
      <div class="col-3 button num p-0" data-value="5">
        <button type="button" class="btn btn-outline-dark w-100 h-100 ripple-surface">5</button>
      </div>
      <div class="col-3 button num p-0" data-value="6">
        <button type="button" class="btn btn-outline-dark w-100 h-100 ripple-surface">6</button>
      </div>
      <div class="col-3 button op p-0" data-value="*">
        <button type="button" class="btn btn-outline-primary w-100 h-100 ripple-surface">x</button>
      </div>
    </div>
    <div class="row g-3">
      <div class="col-3 button num p-0" data-value="1">
        <button type="button" class="btn btn-outline-dark w-100 h-100 ripple-surface">1</button>
      </div>
      <div class="col-3 button num p-0" data-value="2">
        <button type="button" class="btn btn-outline-dark w-100 h-100 ripple-surface">2</button>
      </div>
      <div class="col-3 button num p-0" data-value="3">
        <button type="button" class="btn btn-outline-dark w-100 h-100 ripple-surface">3</button>
      </div>
      <div class="col-3 button op p-0" data-value="/">
        <button type="button" class="btn btn-outline-primary w-100 h-100 ripple-surface">/</button>
      </div>
    </div>
    <div class="row g-3">
      <div class="col-3 button p-0 bracket">
        <button type="button" class="btn btn-outline-primary w-100 h-100 ripple-surface">()</button>
      </div>
      <div class="col-3 button num p-0" data-value="0">
        <button type="button" class="btn btn-outline-dark w-100 h-100 ripple-surface">0</button>
      </div>
      <div class="col-3 button num p-0" data-value=".">
        <button type="button" class="btn btn-outline-dark w-100 h-100 ripple-surface">.</button>
      </div>
      <div class="col-3 button equal p-0" data-value="=">
        <button type="button" class="btn text-bg-info w-100 h-100 ripple-surface">=</button>
      </div>
    </div>
  </div>

  <script>
    const display = $("#display");
    let calValue = "";
    const brackets = [];

    $(document).ready(function () {
      $(".num").click(function () {
        const displayValue = $(this).attr("data-value");
        calValue += displayValue;
        display.html(display.html() + displayValue);
      });

      $(".op").click(function () {
        const displayValue = $(this).attr("data-value");
        const lastChar = calValue.slice(-1);
        if (calValue === "" && displayValue !== '-') {
          return;
        } else if (['+', '-', '*', '/'].includes(lastChar)) {
          calValue = calValue.slice(0, -1) + displayValue;
          display.html(display.html().slice(0, -1) + displayValue);
        } else if (lastChar === '(') {
          return;
        } else {
          calValue += displayValue;
          display.html(display.html() + displayValue);
        }
      });

      $(".equal").click(function () {
        if (calValue == "") {
          return;
        }
        if (brackets.length != 0) {
          for (let i = 0; i < brackets.length; i++) {
            calValue += ")";
          }
        }
        const result = String(eval(calValue));
        calValue = result;
        brackets.length = 0;
        display.html(result);
      });

      $(".c").click(function () {
        calValue = "";
        display.html("");
        brackets.length = 0;
      });

      $(".sqrt").click(function(){
                let displayValue = "&radic;("
                let lastNumberMatch = calValue.match(/(\d+\.?\d*)$/);
                
                if (lastNumberMatch) {
                    displayValue = "*" + displayValue;
                    calValue = calValue+'*';
                }
                calValue += "Math.sqrt(";
                brackets.push("(")
                display.html(display.html()+displayValue)
            })
            $(".square").click(function(){
                displayValue = "<sup>2</sup>"
                let lastNumberMatch = calValue.match(/(\d+\.?\d*)$/);
                let lastExpressionMatch = calValue.match(/\(([^()]+)\)$/);

                if (lastNumberMatch) {
                    let lastNumber = lastNumberMatch[0];
                    let squaredValue = Math.pow(lastNumber, 2);
                    calValue = calValue.replace(/(\d+\.?\d*)$/, squaredValue);
                    display.html(display.html()+displayValue)
                }
                else if (lastExpressionMatch) {
                    let lastExpression = lastExpressionMatch[1];
                    let squaredValue = Math.pow(eval(lastExpression), 2); 
                    calValue = calValue.replace(/\(([^()]+)\)$/, squaredValue);
                    display.html(display.html()+displayValue)
                } 
                else {
                    return;
                }
            })
            $(".bracket").click(function(){
                let displayValue = $(this).attr("data-value");
                const lastNumberMatch = calValue.match(/(\d+\.?\d*)$/);
                const operatorMatch = calValue.match(/[\+\-\*\/]$/);
                const lastCharIsClosingBracket = calValue.match(/\)$/);
                const lastCharIsOpeningBracket = calValue.match(/\($/);
                if (operatorMatch) {
                    displayValue = "(";
                    brackets.push("(");
                }
                else if (lastNumberMatch && brackets.length == 0){
                    displayValue = "*("
                    brackets.push("(")
                }else if (lastNumberMatch && brackets.length != 0){
                    displayValue = ")"
                    brackets.pop()
                }else if (lastCharIsClosingBracket && brackets.length != 0) {
                    displayValue = ")";
                    brackets.pop();
                } 
                else if (lastCharIsOpeningBracket || calValue == ""){
                    displayValue = "(";
                    brackets.push("(");
                }
                else{
                    displayValue = "*(";
                    brackets.push("(");
                }
                calValue += displayValue;
                display.html(display.html() + displayValue);
            })
    });
  </script>
</body>

</html>
